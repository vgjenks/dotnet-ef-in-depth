# Isolated `int[]` vs `List<int>` Test

This is a basic isolation test using EF 8 in .NET 8 to compare inline query filtering using int arrays vs int Lists. 

## Setup

First, run MSSQL 2022 Developer locally in Docker:

`docker run --rm -p 1433:1433 -e 'ACCEPT_EULA=1' -e 'MSSQL_SA_PASSWORD=coff33time$' -e 'MSSQL_PID=Developer' -d mcr.microsoft.com/mssql/server:2022-latest`

Open a terminal to root of project and...

Restore packages:

`dotnet restore`

Create test database:

`dotnet ef migrations add Initial`

and...

`dotnet ef database update`

## Run

`dotnet run`

### You should see something very similar to:

```
DECLARE @__arrayFilters_0 nvarchar(4000) = N'[0,3,8,2]';

-- Counts with Contains filter

SELECT [p].[PostId], [p].[BlogId], [p].[Content], [p].[RandomNumber], [p].[Title]
FROM [Posts] AS [p]
WHERE [p].[RandomNumber] IN (
    SELECT [a].[value]
    FROM OPENJSON(@__arrayFilters_0) WITH ([value] int '$') AS [a]
)
Total count: 21, Filtered count: 7
```

This is how MSSQL translates "many of these filtered by many of these" into SQL, using the OPENJSON function. See the PDF file in the root of the project for a deeper AI description of what the query is doing, but it essentially converts the values to JSON so it can filter two collections of data the same way C# is able to.

## Analysis

As always, be very careful what you put into your EF queries in C#. What you do in C#, EF will translate into the best possible SQL code possible, but can often be very inefficient or worse, produce unseen runtime errors in some cases.

There is stll no concrete explanation as to why an int array suddenly stopped working, requiring a codebase-wide change to int Lists, but the best hypothesis is due to the uncontrollable nature of Serverless technologies. Either OTR devs, Microsoft, or both, made changes somewhere in the software within the stack that affected how EF generates queries.

## Final Word

Test, test, TEST your code - both locally and in upper-environments! Walk through your code in the debugger and watch values. Evaluate the SQL being generated by EF using `.ToQueryString()`. Tag your EF queries with `.TagWith()` so the team is able to tie the SQL output back to its EF source.